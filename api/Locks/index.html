<!doctype html>
<html lang="en" dir="ltr" class="plugin-moonwave plugin-id-moonwave" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Locks | Lyra</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://paradoxum-games.github.io/lyra/api/Locks"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Locks | Lyra"><meta data-rh="true" name="description" content="Implements a distributed locking mechanism using Roblox&#x27;s MemoryStoreService.
This allows coordinating access to shared resources (like DataStore keys)
across different game servers or instances.

The locking strategy involves:
- Attempting to atomically acquire a lock using `MemoryStoreService:UpdateAsync`.
- Setting a Time-To-Live (TTL) on the lock key in MemoryStore.
- Periodically refreshing the lock&#x27;s TTL in a background task to maintain ownership.
- Providing a mechanism (`onLockLost`) to notify the holder if the lock refresh fails
  or the lock expires unexpectedly.

This ensures that typically only one process holds the lock for a given key at a time."><meta data-rh="true" property="og:description" content="Implements a distributed locking mechanism using Roblox&#x27;s MemoryStoreService.
This allows coordinating access to shared resources (like DataStore keys)
across different game servers or instances.

The locking strategy involves:
- Attempting to atomically acquire a lock using `MemoryStoreService:UpdateAsync`.
- Setting a Time-To-Live (TTL) on the lock key in MemoryStore.
- Periodically refreshing the lock&#x27;s TTL in a background task to maintain ownership.
- Providing a mechanism (`onLockLost`) to notify the holder if the lock refresh fails
  or the lock expires unexpectedly.

This ensures that typically only one process holds the lock for a given key at a time."><link data-rh="true" rel="canonical" href="https://paradoxum-games.github.io/lyra/api/Locks"><link data-rh="true" rel="alternate" href="https://paradoxum-games.github.io/lyra/api/Locks" hreflang="en"><link data-rh="true" rel="alternate" href="https://paradoxum-games.github.io/lyra/api/Locks" hreflang="x-default"><link rel="stylesheet" href="/lyra/assets/css/styles.f56ecc6a.css">
<script src="/lyra/assets/js/runtime~main.4a9be780.js" defer="defer"></script>
<script src="/lyra/assets/js/main.3498456b.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/lyra/"><b class="navbar__title text--truncate">Lyra</b></a><a class="navbar__item navbar__link" href="/lyra/docs/intro">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/lyra/api/">API</a><a class="navbar__item navbar__link" href="/lyra/changelog">Changelog</a></div><div class="navbar__items navbar__items--right"><a href="https://wally.run/package/paradoxum-games/lyra" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Wally<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/paradoxum-games/lyra" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input id="search_input_react" type="search" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docPageContainer_wNNk"><div class="docPage_Dpn1"><div class="docSidebarContainer_o_re"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/lyra/api/PlayerStore">​Player​Store</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/lyra/api/Lyra">​Lyra</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/lyra/api/Store">Internal</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/lyra/api/Store">​Store</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/lyra/api/Session">​Session</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/lyra/api/Locks">​Locks</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/lyra/api/Constants">​Constants</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/lyra/api/Files">​Files</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/lyra/api/Log">​Log</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/lyra/api/PromiseQueue">​Promise​Queue</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/lyra/api/Types">​Types</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/lyra/api/Transactions">​Transactions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/lyra/api/Migrations">​Migrations</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/lyra/api/hashMapRetry">hash​Map​Retry</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/lyra/api/dataStoreRetry">data​Store​Retry</a></li></ul></li></ul></nav></div></div><main class="docMainContainer_HJE1"><div class="container padding-vert--lg"><div class="row"><div class="col docItemCol_MU3C"><div class="docItemContainer_Wv98"><article><div class="member_J0w1 markdown"><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_oUs_"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><header><h1 class="docTitle_mZRt" style="text-decoration:none"><span style="display:inline-block">Locks</span></h1><div class="luaClassTags_EipM"><span class="badge_Ba2I" style="color:#9b59b6"><span class="badgeTooltip_cWXP">This item is only intended to be used by the module&#x27;s authors.</span><span class="badgeToolTipTail_H9D_"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" fill="#9b59b6" role="img" aria-label="This item is only intended to be used by the module&#x27;s authors."><path d="m49.2 36 14.3 12.7.1-.7c0-6.7-6.1-12.1-13.6-12.1l-.8.1z"></path><path d="M50 27.8c12.5 0 22.7 9 22.7 20.1 0 2.6-.6 5-1.6 7.3L84.4 67c6.9-5 12.3-11.6 15.6-19.1-7.9-17.6-27.3-30.1-50-30.1-6.4 0-12.5 1-18.1 2.8l9.8 8.6c2.6-.8 5.4-1.4 8.3-1.4zM4.5 16.9l10.4 9.2 2.1 1.8C9.5 33.1 3.5 40 0 48c7.9 17.7 27.3 30.2 50 30.2 7 0 13.8-1.2 19.9-3.4l1.9 1.7 13.3 11.7 5.8-5.1-80.6-71.3-5.8 5.1zm25.2 22.2 7 6.2c-.2.8-.3 1.8-.3 2.6C36.4 54.6 42.5 60 50 60c1 0 2-.2 3-.3l7 6.2c-3 1.3-6.4 2.1-10 2.1-12.5 0-22.7-9-22.7-20.1 0-3.1.9-6.1 2.4-8.8z"></path></svg> <!-- -->Private</span></span></div><label class="privateToggle_lmfE"><span class="privateCheckboxContainer_psRa"><input class="privateCheckboxInternal_IKP2" type="checkbox" name="checkbox"><span class="privateCheckboxControl_Ov8U"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path fill="none" stroke="currentColor" stroke-width="3" d="M4 11.91l5.37 5.37L19.79 5.59"></path></svg></span></span><span class="privateCheckboxLabel_Vmvs">Show Private</span></label><div>
<p>
  Implements a distributed locking mechanism using Roblox's MemoryStoreService.
  This allows coordinating access to shared resources (like DataStore keys)
  across different game servers or instances.
</p>
<p>The locking strategy involves:</p>
<ul>
  <li>Attempting to atomically acquire a lock using <code>MemoryStoreService:UpdateAsync</code>.</li>
  <li>Setting a Time-To-Live (TTL) on the lock key in MemoryStore.</li>
  <li>Periodically refreshing the lock's TTL in a background task to maintain ownership.</li>
  <li>
    Providing a mechanism (<code>onLockLost</code>) to notify the holder if the lock refresh fails
    or the lock expires unexpectedly.
  </li>
</ul>
<p>This ensures that typically only one process holds the lock for a given key at a time.</p>
</div></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="types">Types<a href="#types" class="hash-link" aria-label="Direct link to Types" title="Direct link to Types">​</a></h2><div class="divider_rE5g"></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="LockHandle"><code style="text-decoration:none">LockHandle</code><a href="#LockHandle" class="hash-link" aria-label="Direct link to LockHandle" title="Direct link to LockHandle">​</a></h3><div class="repositoryDetailsContainer_BPdw"><a class="sourceButton_sEho" href="https://github.com/paradoxum-games/lyra/blob/main/src/Locks.luau#L49"><div class="sourceButtonText_Vh0m">&lt;/&gt;</div></a></div><div class="memberString_GwaU"><code class="purple_ieR2">interface</code> <code>LockHandle<!-- --> <!-- -->{</code><div class="inset_uKQm"><div><code>release<!-- -->: </code><code class="purple_ieR2">(</code><code class="purple_ieR2">)</code><code class="purple_ieR2"> → </code><code class="blue_P4bS">Promise</code><span class="inlineDescription_G7Er">-- <span>
<p>Releases the lock immediately. Stops the refresh loop and attempts to clear the lock key in MemoryStore (by setting TTL to 0). Resolves when the release attempt is complete.</p>
</span></span></div><div><code>isLocked<!-- -->: </code><code class="purple_ieR2">(</code><code class="purple_ieR2">)</code><code class="purple_ieR2"> → </code><code class="blue_P4bS">boolean</code><span class="inlineDescription_G7Er">-- <span>
<p>Checks if the lock is currently considered held locally. This checks both the internal status and compares the last confirmed expiry time (from MemoryStore) against the current local time. True if the lock is believed to be held.</p>
</span></span></div><div><code>onLockLost<!-- -->: </code><code class="purple_ieR2">(</code><code class="green_DgR4">(</code><code class="green_DgR4">)</code><code class="green_DgR4"> → </code><code class="green_DgR4">(</code><code class="green_DgR4">)</code><code class="purple_ieR2">)</code><code class="purple_ieR2"> → </code><code class="purple_ieR2">(</code><code class="green_DgR4">(</code><code class="green_DgR4">)</code><code class="green_DgR4"> → </code><code class="green_DgR4">(</code><code class="green_DgR4">)</code><code class="purple_ieR2">)</code><span class="inlineDescription_G7Er">-- <span>
<p>Registers a callback function to be invoked if the lock is lost unexpectedly (e.g., refresh fails, TTL expires). Returns a function to disconnect/unregister the callback.</p>
</span></span></div></div><code>}</code></div><div>
<p>Represents an acquired lock handle, providing methods to interact with the lock.</p>
</div><div class="divider_rE5g"></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="AcquireLockParams"><code style="text-decoration:none">AcquireLockParams</code><a href="#AcquireLockParams" class="hash-link" aria-label="Direct link to AcquireLockParams" title="Direct link to AcquireLockParams">​</a></h3><div class="repositoryDetailsContainer_BPdw"><a class="sourceButton_sEho" href="https://github.com/paradoxum-games/lyra/blob/main/src/Locks.luau#L65"><div class="sourceButtonText_Vh0m">&lt;/&gt;</div></a></div><div class="memberString_GwaU"><code class="purple_ieR2">interface</code> <code>AcquireLockParams<!-- --> <!-- -->{</code><div class="inset_uKQm"><div><code>storeContext<!-- -->: </code><code class="blue_P4bS">Types.StoreContext</code><code class="op_lSLc">&lt;</code><code class="blue_P4bS">any</code><code class="op_lSLc">&gt;</code><span class="inlineDescription_G7Er">-- <span>
<p>Shared store context containing logger and MemoryStoreHashMap instance.</p>
</span></span></div><div><code>key<!-- -->: </code><code class="blue_P4bS">string</code><span class="inlineDescription_G7Er">-- <span>
<p>The unique key identifying the resource to be locked.</p>
</span></span></div><div><code>duration<!-- -->: </code><code class="blue_P4bS">number</code><span class="inlineDescription_G7Er">-- <span>
<p>The duration (TTL) in seconds for which the lock should be held/refreshed.</p>
</span></span></div><div><code>refreshInterval<!-- -->: </code><code class="blue_P4bS">number</code><span class="inlineDescription_G7Er">-- <span>
<p>The interval in seconds at which the lock refresh should be attempted.</p>
</span></span></div></div><code>}</code></div><div>
<p>Parameters for acquiring a lock.</p>
</div><div class="divider_rE5g"></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ProbeLockActiveParams"><code style="text-decoration:none">ProbeLockActiveParams</code><a href="#ProbeLockActiveParams" class="hash-link" aria-label="Direct link to ProbeLockActiveParams" title="Direct link to ProbeLockActiveParams">​</a></h3><div class="repositoryDetailsContainer_BPdw"><a class="sourceButton_sEho" href="https://github.com/paradoxum-games/lyra/blob/main/src/Locks.luau#L445"><div class="sourceButtonText_Vh0m">&lt;/&gt;</div></a></div><div class="memberString_GwaU"><code class="purple_ieR2">interface</code> <code>ProbeLockActiveParams<!-- --> <!-- -->{</code><div class="inset_uKQm"><div><code>storeContext<!-- -->: </code><code class="blue_P4bS">Types.StoreContext</code><code class="op_lSLc">&lt;</code><code class="blue_P4bS">any</code><code class="op_lSLc">&gt;</code><span class="inlineDescription_G7Er">-- <span>
<p>Shared store context containing logger and MemoryStoreHashMap instance.</p>
</span></span></div><div><code>key<!-- -->: </code><code class="blue_P4bS">string</code><span class="inlineDescription_G7Er">-- <span>
<p>The unique key identifying the resource to be locked.</p>
</span></span></div></div><code>}</code></div><div>
<p>Parameters for probing if a lock is active.</p>
</div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="functions">Functions<a href="#functions" class="hash-link" aria-label="Direct link to Functions" title="Direct link to Functions">​</a></h2><div class="divider_rE5g"></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="acquireLock"><code style="text-decoration:none">acquireLock</code><a href="#acquireLock" class="hash-link" aria-label="Direct link to acquireLock" title="Direct link to acquireLock">​</a></h3><div class="repositoryDetailsContainer_BPdw"><a class="sourceButton_sEho" href="https://github.com/paradoxum-games/lyra/blob/main/src/Locks.luau#L84"><div class="sourceButtonText_Vh0m">&lt;/&gt;</div></a></div><div class="memberString_GwaU"><code>Locks<!-- -->.</code><code class="green_DgR4">acquireLock</code><code>(</code><div class="inset_uKQm"><div><code>params<!-- -->: </code><code class="blue_P4bS"><a style="text-decoration:underline;color:inherit" href="/lyra/api/Locks#AcquireLockParams">AcquireLockParams</a></code><span class="inlineDescription_G7Er">-- <span>
<p>Configuration for the lock acquisition.</p>
</span></span></div></div><code>) → </code><code class="blue_P4bS">Promise</code><code class="op_lSLc">&lt;</code><code class="blue_P4bS"><a style="text-decoration:underline;color:inherit" href="/lyra/api/Locks#LockHandle">LockHandle</a></code><code class="op_lSLc">&gt;</code><span class="inlineDescription_G7Er">-- <span>
<p>Resolves with a LockHandle if the lock is acquired successfully.</p>
</span></span></div><div>
<p>Attempts to acquire a distributed lock for the specified key.</p>
<p>
  Manages the lock acquisition process, including retries with exponential
  backoff, setting up the background refresh loop, and providing a LockHandle
  on success.
</p>
</div><h3>Errors</h3><table class="errorTable_jfN8"><thead><tr><th>Type</th><th>Description</th></tr></thead><tbody><tr><td>Rejects if the lock cannot be acquired within the specified duration/attempts, or if other MemoryStore errors occur.</td><td></td></tr></tbody></table><div class="divider_rE5g"></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="probeLockActive"><code style="text-decoration:none">probeLockActive</code><a href="#probeLockActive" class="hash-link" aria-label="Direct link to probeLockActive" title="Direct link to probeLockActive">​</a></h3><div class="repositoryDetailsContainer_BPdw"><a class="sourceButton_sEho" href="https://github.com/paradoxum-games/lyra/blob/main/src/Locks.luau#L461"><div class="sourceButtonText_Vh0m">&lt;/&gt;</div></a></div><div class="memberString_GwaU"><code>Locks<!-- -->.</code><code class="green_DgR4">probeLockActive</code><code>(</code><div class="inset_uKQm"><div><code>params<!-- -->: </code><code class="blue_P4bS"><a style="text-decoration:underline;color:inherit" href="/lyra/api/Locks#ProbeLockActiveParams">ProbeLockActiveParams</a></code><span class="inlineDescription_G7Er">-- <span>
<p>Parameters for probing the lock.</p>
</span></span></div></div><code>) → </code><code class="blue_P4bS">Promise</code><code class="op_lSLc">&lt;</code><code class="blue_P4bS">boolean</code><code class="op_lSLc">&gt;</code><span class="inlineDescription_G7Er">-- <span>
<p>Resolves with true if the lock key exists, false otherwise.</p>
</span></span></div><div>
<p>
  Checks if a lock key currently exists in MemoryStore without attempting to acquire it.
  Useful for determining if another process likely holds the lock.
</p>
<p>
  Note: This is a point-in-time check and doesn't guarantee the lock state won't
  change immediately after the check completes.
</p>
</div></div></article></div><details><summary>Show raw api</summary><pre style="max-width:100%;white-space:pre-wrap">{
    &quot;functions&quot;: [
        {
            &quot;name&quot;: &quot;acquireLock&quot;,
            &quot;desc&quot;: &quot;Attempts to acquire a distributed lock for the specified key.\n\nManages the lock acquisition process, including retries with exponential\nbackoff, setting up the background refresh loop, and providing a LockHandle\non success.&quot;,
            &quot;params&quot;: [
                {
                    &quot;name&quot;: &quot;params&quot;,
                    &quot;desc&quot;: &quot;Configuration for the lock acquisition.&quot;,
                    &quot;lua_type&quot;: &quot;AcquireLockParams&quot;
                }
            ],
            &quot;returns&quot;: [
                {
                    &quot;desc&quot;: &quot;Resolves with a LockHandle if the lock is acquired successfully.&quot;,
                    &quot;lua_type&quot;: &quot;Promise&lt;LockHandle&gt;&quot;
                }
            ],
            &quot;function_type&quot;: &quot;static&quot;,
            &quot;errors&quot;: [
                {
                    &quot;lua_type&quot;: &quot;Rejects if the lock cannot be acquired within the specified duration/attempts, or if other MemoryStore errors occur.&quot;,
                    &quot;desc&quot;: &quot;&quot;
                }
            ],
            &quot;source&quot;: {
                &quot;line&quot;: 84,
                &quot;path&quot;: &quot;src/Locks.luau&quot;
            }
        },
        {
            &quot;name&quot;: &quot;transitionTo&quot;,
            &quot;desc&quot;: &quot;Helper function to update the internal lock status and log the transition.\n\t&quot;,
            &quot;params&quot;: [
                {
                    &quot;name&quot;: &quot;newStatus&quot;,
                    &quot;desc&quot;: &quot;The new status to set.&quot;,
                    &quot;lua_type&quot;: &quot;LockStatus&quot;
                }
            ],
            &quot;returns&quot;: [],
            &quot;function_type&quot;: &quot;static&quot;,
            &quot;private&quot;: true,
            &quot;source&quot;: {
                &quot;line&quot;: 110,
                &quot;path&quot;: &quot;src/Locks.luau&quot;
            }
        },
        {
            &quot;name&quot;: &quot;spawnExpiryCallbacks&quot;,
            &quot;desc&quot;: &quot;Invokes all registered `onLockLost` callbacks.\nCalled when the local expiry timer (`expiryThread`) fires or when refresh fails.\n\t&quot;,
            &quot;params&quot;: [],
            &quot;returns&quot;: [],
            &quot;function_type&quot;: &quot;static&quot;,
            &quot;private&quot;: true,
            &quot;source&quot;: {
                &quot;line&quot;: 121,
                &quot;path&quot;: &quot;src/Locks.luau&quot;
            }
        },
        {
            &quot;name&quot;: &quot;tryUpdate&quot;,
            &quot;desc&quot;: &quot;Attempts to update the lock key in MemoryStore using UpdateAsync.\nThis is used for initial acquisition, refresh, and release (with ttl=0).\n\nThe transform function ensures atomicity:\n- If the key doesn&#x27;t exist (`otherLockId == nil`), set it to our `lockId`.\n- If the key exists and holds our `lockId`, update the TTL (refresh).\n- If the key exists and holds a different `lockId`, do nothing (fail acquisition/refresh).\n\nAlso manages the local expiry timer (`expiryThread`) based on successful updates.\n\n\t&quot;,
            &quot;params&quot;: [
                {
                    &quot;name&quot;: &quot;ttl&quot;,
                    &quot;desc&quot;: &quot;The Time-To-Live in seconds for the UpdateAsync call.&quot;,
                    &quot;lua_type&quot;: &quot;number&quot;
                }
            ],
            &quot;returns&quot;: [
                {
                    &quot;desc&quot;: &quot;Handle containing the promise and cancel function from `hashMapRetry`.&quot;,
                    &quot;lua_type&quot;: &quot;Types.RetryHandle&lt;Promise&lt;any&gt;&gt;&quot;
                }
            ],
            &quot;function_type&quot;: &quot;static&quot;,
            &quot;private&quot;: true,
            &quot;source&quot;: {
                &quot;line&quot;: 148,
                &quot;path&quot;: &quot;src/Locks.luau&quot;
            }
        },
        {
            &quot;name&quot;: &quot;release&quot;,
            &quot;desc&quot;: &quot;Releases the lock. Stops refresh/expiry timers and attempts to clear the\nlock in MemoryStore by setting TTL to 0.\n\n\t&quot;,
            &quot;params&quot;: [],
            &quot;returns&quot;: [
                {
                    &quot;desc&quot;: &quot;Resolves when the release process is complete.&quot;,
                    &quot;lua_type&quot;: &quot;Promise&quot;
                }
            ],
            &quot;function_type&quot;: &quot;static&quot;,
            &quot;private&quot;: true,
            &quot;source&quot;: {
                &quot;line&quot;: 201,
                &quot;path&quot;: &quot;src/Locks.luau&quot;
            }
        },
        {
            &quot;name&quot;: &quot;waitForLock&quot;,
            &quot;desc&quot;: &quot;Main loop for attempting to acquire the lock initially.\nUses `tryUpdate` with exponential backoff.\n\n\t&quot;,
            &quot;params&quot;: [],
            &quot;returns&quot;: [
                {
                    &quot;desc&quot;: &quot;Resolves when the lock is acquired, rejects if timeout occurs.&quot;,
                    &quot;lua_type&quot;: &quot;Promise&quot;
                }
            ],
            &quot;function_type&quot;: &quot;static&quot;,
            &quot;private&quot;: true,
            &quot;source&quot;: {
                &quot;line&quot;: 249,
                &quot;path&quot;: &quot;src/Locks.luau&quot;
            }
        },
        {
            &quot;name&quot;: &quot;setupLockRefresh&quot;,
            &quot;desc&quot;: &quot;Starts the background loop responsible for periodically refreshing the lock TTL.\n\t&quot;,
            &quot;params&quot;: [],
            &quot;returns&quot;: [],
            &quot;function_type&quot;: &quot;static&quot;,
            &quot;private&quot;: true,
            &quot;source&quot;: {
                &quot;line&quot;: 338,
                &quot;path&quot;: &quot;src/Locks.luau&quot;
            }
        },
        {
            &quot;name&quot;: &quot;probeLockActive&quot;,
            &quot;desc&quot;: &quot;Checks if a lock key currently exists in MemoryStore without attempting to acquire it.\nUseful for determining if another process likely holds the lock.\n\nNote: This is a point-in-time check and doesn&#x27;t guarantee the lock state won&#x27;t\nchange immediately after the check completes.&quot;,
            &quot;params&quot;: [
                {
                    &quot;name&quot;: &quot;params&quot;,
                    &quot;desc&quot;: &quot;Parameters for probing the lock.&quot;,
                    &quot;lua_type&quot;: &quot;ProbeLockActiveParams&quot;
                }
            ],
            &quot;returns&quot;: [
                {
                    &quot;desc&quot;: &quot;Resolves with true if the lock key exists, false otherwise.&quot;,
                    &quot;lua_type&quot;: &quot;Promise&lt;boolean&gt;&quot;
                }
            ],
            &quot;function_type&quot;: &quot;static&quot;,
            &quot;source&quot;: {
                &quot;line&quot;: 461,
                &quot;path&quot;: &quot;src/Locks.luau&quot;
            }
        }
    ],
    &quot;properties&quot;: [],
    &quot;types&quot;: [
        {
            &quot;name&quot;: &quot;LockStatus&quot;,
            &quot;desc&quot;: &quot;Possible states of the lock acquisition and holding process.&quot;,
            &quot;lua_type&quot;: &quot;\&quot;acquiring\&quot; | \&quot;held\&quot; | \&quot;released\&quot;&quot;,
            &quot;tags&quot;: [
                &quot;enum&quot;
            ],
            &quot;private&quot;: true,
            &quot;source&quot;: {
                &quot;line&quot;: 38,
                &quot;path&quot;: &quot;src/Locks.luau&quot;
            }
        },
        {
            &quot;name&quot;: &quot;LockHandle&quot;,
            &quot;desc&quot;: &quot;Represents an acquired lock handle, providing methods to interact with the lock.&quot;,
            &quot;fields&quot;: [
                {
                    &quot;name&quot;: &quot;release&quot;,
                    &quot;lua_type&quot;: &quot;() -&gt; Promise&quot;,
                    &quot;desc&quot;: &quot;Releases the lock immediately. Stops the refresh loop and attempts to clear the lock key in MemoryStore (by setting TTL to 0). Resolves when the release attempt is complete.&quot;
                },
                {
                    &quot;name&quot;: &quot;isLocked&quot;,
                    &quot;lua_type&quot;: &quot;() -&gt; boolean&quot;,
                    &quot;desc&quot;: &quot;Checks if the lock is currently considered held locally. This checks both the internal status and compares the last confirmed expiry time (from MemoryStore) against the current local time. True if the lock is believed to be held.&quot;
                },
                {
                    &quot;name&quot;: &quot;onLockLost&quot;,
                    &quot;lua_type&quot;: &quot;(() -&gt; ()) -&gt; (() -&gt; ())&quot;,
                    &quot;desc&quot;: &quot;Registers a callback function to be invoked if the lock is lost unexpectedly (e.g., refresh fails, TTL expires). Returns a function to disconnect/unregister the callback.&quot;
                }
            ],
            &quot;source&quot;: {
                &quot;line&quot;: 49,
                &quot;path&quot;: &quot;src/Locks.luau&quot;
            }
        },
        {
            &quot;name&quot;: &quot;AcquireLockParams&quot;,
            &quot;desc&quot;: &quot;Parameters for acquiring a lock.&quot;,
            &quot;fields&quot;: [
                {
                    &quot;name&quot;: &quot;storeContext&quot;,
                    &quot;lua_type&quot;: &quot;Types.StoreContext&lt;any&gt;&quot;,
                    &quot;desc&quot;: &quot;Shared store context containing logger and MemoryStoreHashMap instance.&quot;
                },
                {
                    &quot;name&quot;: &quot;key&quot;,
                    &quot;lua_type&quot;: &quot;string&quot;,
                    &quot;desc&quot;: &quot;The unique key identifying the resource to be locked.&quot;
                },
                {
                    &quot;name&quot;: &quot;duration&quot;,
                    &quot;lua_type&quot;: &quot;number&quot;,
                    &quot;desc&quot;: &quot;The duration (TTL) in seconds for which the lock should be held/refreshed.&quot;
                },
                {
                    &quot;name&quot;: &quot;refreshInterval&quot;,
                    &quot;lua_type&quot;: &quot;number&quot;,
                    &quot;desc&quot;: &quot;The interval in seconds at which the lock refresh should be attempted.&quot;
                }
            ],
            &quot;source&quot;: {
                &quot;line&quot;: 65,
                &quot;path&quot;: &quot;src/Locks.luau&quot;
            }
        },
        {
            &quot;name&quot;: &quot;ProbeLockActiveParams&quot;,
            &quot;desc&quot;: &quot;Parameters for probing if a lock is active.&quot;,
            &quot;fields&quot;: [
                {
                    &quot;name&quot;: &quot;storeContext&quot;,
                    &quot;lua_type&quot;: &quot;Types.StoreContext&lt;any&gt;&quot;,
                    &quot;desc&quot;: &quot;Shared store context containing logger and MemoryStoreHashMap instance.&quot;
                },
                {
                    &quot;name&quot;: &quot;key&quot;,
                    &quot;lua_type&quot;: &quot;string&quot;,
                    &quot;desc&quot;: &quot;The unique key identifying the resource to be locked.&quot;
                }
            ],
            &quot;source&quot;: {
                &quot;line&quot;: 445,
                &quot;path&quot;: &quot;src/Locks.luau&quot;
            }
        }
    ],
    &quot;name&quot;: &quot;Locks&quot;,
    &quot;desc&quot;: &quot;Implements a distributed locking mechanism using Roblox&#x27;s MemoryStoreService.\nThis allows coordinating access to shared resources (like DataStore keys)\nacross different game servers or instances.\n\nThe locking strategy involves:\n- Attempting to atomically acquire a lock using `MemoryStoreService:UpdateAsync`.\n- Setting a Time-To-Live (TTL) on the lock key in MemoryStore.\n- Periodically refreshing the lock&#x27;s TTL in a background task to maintain ownership.\n- Providing a mechanism (`onLockLost`) to notify the holder if the lock refresh fails\n  or the lock expires unexpectedly.\n\nThis ensures that typically only one process holds the lock for a given key at a time.&quot;,
    &quot;private&quot;: true,
    &quot;source&quot;: {
        &quot;line&quot;: 18,
        &quot;path&quot;: &quot;src/Locks.luau&quot;
    }
}</pre></details></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#types" class="table-of-contents__link toc-highlight">Types</a><ul><li><a href="#AcquireLockParams" class="table-of-contents__link toc-highlight">AcquireLockParams</a></li><li><a href="#LockHandle" class="table-of-contents__link toc-highlight">LockHandle</a></li><li><a href="#ProbeLockActiveParams" class="table-of-contents__link toc-highlight">ProbeLockActiveParams</a></li></ul></li><li><a href="#functions" class="table-of-contents__link toc-highlight">Functions</a><ul><li><a href="#acquireLock" class="table-of-contents__link toc-highlight">.acquireLock</a></li><li><a href="#probeLockActive" class="table-of-contents__link toc-highlight">.probeLockActive</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Links</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/paradoxum-games/lyra" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Built with Moonwave and Docusaurus</div></div></div></footer></div>
</body>
</html>